From c3bc1c1fbc446562e46bdaeb0508fe53b2953f61 Mon Sep 17 00:00:00 2001
From: Owen Anderson <owenthomasanderson@gmail.com>
Date: Thu, 19 Aug 2021 14:11:41 -0400
Subject: [PATCH] Adding changes d515f6b6cde357bf480d32a7387f07ea40e85e52 and
 3933e29d1b87c713167cf4730b68e5f18af4f140 from openwrt

---
 .../kernel/mac80211/files/lib/netifd/wireless/mac80211.sh   | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh b/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh
index cf3e7ffbb8..a84fb8a7ae 100644
--- a/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh
+++ b/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh
@@ -741,6 +741,8 @@ drv_mac80211_setup() {
 	}
 
 	wireless_set_data phy="$phy"
+	[ -z "$(uci -q -P /var/state show wireless._${phy})" ] && uci -q -P /var/state set wireless._${phy}=phy
+
 	mac80211_interface_cleanup "$phy"
 
 	# convert channel to frequency
@@ -825,6 +827,10 @@ drv_mac80211_teardown() {
 	json_select data
 	json_get_vars phy
 	json_select ..
+	[ -n "$phy" ] || {
+		echo "Bug: PHY is undefined for device '$1'"
+		return 1
+	}
 
 	mac80211_interface_cleanup "$phy"
 }
-- 
2.25.1

