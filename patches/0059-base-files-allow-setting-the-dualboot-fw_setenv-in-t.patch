From 8046f2a5a614bcca0a6cd602640f38084a379551 Mon Sep 17 00:00:00 2001
From: Tanya Singh <tanya_singh@accton.com>
Date: Tue, 12 Mar 2024 14:18:27 +0800
Subject: [PATCH] base-files: allow setting the dualboot fw_setenv in the
 sysupgrade sucess handler

---
 package/base-files/files/lib/upgrade/nand.sh | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/package/base-files/files/lib/upgrade/nand.sh b/package/base-files/files/lib/upgrade/nand.sh
index d910bf17915..b298b01351a 100644
--- a/package/base-files/files/lib/upgrade/nand.sh
+++ b/package/base-files/files/lib/upgrade/nand.sh
@@ -14,6 +14,9 @@ CI_UBIPART="${CI_UBIPART:-ubi}"
 # 'rootfs' UBI volume on NAND contains the rootfs
 CI_ROOTPART="${CI_ROOTPART:-rootfs}"
 
+# update uboot-env if upgrade suceeded
+CI_FWSETENV=
+
 ubi_mknod() {
 	local dir="$1"
 	local dev="/dev/$(basename $dir)"
@@ -429,6 +432,7 @@ nand_do_upgrade() {
 
 nand_do_upgrade_success() {
 	if nand_do_restore_config && sync; then
+		[ -n "$CI_FWSETENV" ] && fw_setenv $CI_FWSETENV
 		echo "sysupgrade successful"
 		umount -a
 		reboot -f
-- 
2.34.1

